#!/usr/bin/env fish
# â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
# â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•”â•â•â•â•â•
# â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
# â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â• â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•”â•â•â•
# â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
#  â•šâ•â•â•â•â•â• â•šâ•â•     â•šâ•â•â•â•â•â• â•šâ•â•  â•šâ•â•   â•šâ•â•   â•šâ•â•â•â•â•â•â•
#  A script to update all the things

# TODO: update to use AI to summarize

tmux rename-session -t $(tmux display-message -p '#S') "ðŸŒŽ updating"

gum style \
    --foreground 12 --border-foreground 12 --border double \
    --align center --width 60 --margin "1 0" --padding "1 0" \
    'â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•”â•â•â•â•â•
â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  
â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â• â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•”â•â•â•  
â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
 â•šâ•â•â•â•â•â• â•šâ•â•     â•šâ•â•â•â•â•â• â•šâ•â•  â•šâ•â•   â•šâ•â•   â•šâ•â•â•â•â•â•â•'

set -l NOW (date +"%Y-%m-%d-%H-%M-%S")
echo -e "$NOW\n" >>/tmp/u-$NOW.txt

tmux split-window -h "tail -f /tmp/u-$NOW.txt"

# gh cli extensions
set GH_EXTENSION_UPDATE $(gum spin --spinner globe --title "ðŸ™ gh extensions upgrading..." -- gh extension upgrade --all)

echo "âœ… ðŸ™ gh extensions upgraded"
# echo "$GH_EXTENSION_UPDATE" | mods --role updates_gh_dash --no-cache -q

echo $GH_EXTENSION_UPDATE >>/tmp/u-$NOW.txt
echo "\n" >>/tmp/u-$NOW.txt

# tpm plugins
gum spin --spinner globe --title "ðŸªŸ tpm plugins updating..." -- ~/.config/tmux/plugins/tpm/bin/update_plugins all >>/tmp/u-$NOW.txt

echo "\n" >>/tmp/u-$NOW.txt
echo "âœ… ðŸªŸ tpm plugins updated"

gum spin --spinner globe --title "ðŸ  fisher plugins updating..." -- fisher update >>/tmp/u-$NOW.txt
echo "\n" >>/tmp/u-$NOW.txt
echo "âœ… ðŸ  fisher plugins updated"

# TODO: auto-open neovim instead?
# gum spin --spinner globe --title "ðŸ’¤ lazy.nvim syncing..." -- nvim --headless "+Lazy! sync" +qa
# echo "\n" >>/tmp/u-$NOW.txt
# echo "âœ… ðŸ’¤ lazy.nvim synced"

# gum spin --spinner globe --title "ðŸ§° mason.nvim tools updating" -- nvim --headless -c MasonToolsUpdate -c "autocmd User MasonToolsUpdateCompleted quitall!"
# echo "\n" >>/tmp/u-$NOW.txt
# echo "âœ… ðŸ§° mason.nvim tools updated"

gum spin --spinner globe --title "ðŸŒ³ nvim-treesitter updating" -- nvim --headless -c TSUpdate +qa
echo "\n" >>/tmp/u-$NOW.txt
echo "âœ… ðŸŒ³ nvim-treesitter updated"

gum spin --spinner globe --title "ðŸ» brew updating" -- brew update >>/tmp/u-$NOW.txt
echo "\n" >>/tmp/u-$NOW.txt
echo "âœ… ðŸ» brew updated"

set -l OUTDATED (brew outdated)
echo $OUTDATED >>/tmp/u-$NOW.txt

if test -n "$OUTDATED"
    gum spin --spinner globe --title "ðŸ» brew upgrading" -- brew upgrade >>/tmp/u-$NOW.txt
    echo "\n" >>/tmp/u-$NOW.txt
    echo "âœ… ðŸ» brew upgraded"

    gum spin --spinner globe --title "ðŸ» brew cleaning up" -- brew cleanup --prune=all >>/tmp/u-$NOW.txt
    echo "\n" >>/tmp/u-$NOW.txt
    echo "âœ… ðŸ» brew cleaned up"
else
    echo "No outdated brew packages" >>/tmp/u-$NOW.txt
end

gum spin --spinner globe --title "ðŸ» brew doctoring" -- brew doctor >>/tmp/u-$NOW.txt
echo "\n" >>/tmp/u-$NOW.txt
echo "âœ… ðŸ» brew doctored"

gum spin --spinner globe --title "ðŸŽ mas upgrading" -- mas upgrade >>/tmp/u-$NOW.txt
echo "\n" >>/tmp/u-$NOW.txt
echo "âœ… ðŸŽ mas upgraded"

gum spin --spinner globe --title "ðŸ§¶ fabric upgrading" -- go install github.com/danielmiessler/fabric@latest >>/tmp/u-$NOW.txt
echo "\n" >>/tmp/u-$NOW.txt
echo "âœ… ðŸ§¶ fabric upgraded"

echo "âœ… ðŸ§¾ logged to /tmp/u-$NOW.txt"

# TODO: create fabric prompt to summarize all the updates
# TODO: output summmary with glow (already done?)

# tmux rename-session -t $(tmux display-message -p '#S') "ðŸŒŽ updated"
# say "	All modules updated. Handing control back to operator."
